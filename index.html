<script>
        // --- INICJALIZACJA AOS ---
        AOS.init({
            duration: 800,
            once: true
        });

        // --- STAN APLIKACJI ---
        let currentStep = 1;
        const totalSteps = 5;
        let configState = {
            basePrice: 105000,
            colorPrice: 0,
            colorName: 'Biel Alpejska',
            wheelPrice: 0,
            wheelName: '17" Bahamas',
            totalPrice: 105000,
            salon: ''
        };

        // --- OBSŁUGA KROKÓW ---
        const steps = document.querySelectorAll('.step-content');
        const dots = document.querySelectorAll('.step-dot');
        const btnNext = document.getElementById('btn-next');
        const btnPrev = document.getElementById('btn-prev');
        const navBtns = document.getElementById('nav-btns');

        function changeStep(direction) {
            // Walidacja KROKU 3 (Zgody)
            if(direction === 1 && currentStep === 3 && !validateStep3(true)) {
                return;
            }

            // POPRAWKA: Usunięto blokadę kroku 4, aby BLIK mógł wywołać przejście dalej

            // Aktualizacja UI (ukrycie obecnego)
            steps[currentStep - 1].classList.remove('active');
            
            // Zmiana numeru kroku
            currentStep += direction;
            
            // Pokazanie nowego kroku
            steps[currentStep - 1].classList.add('active');

            // Aktualizacja przycisków nawigacji
            btnPrev.disabled = currentStep === 1;
            
            // Logika wyświetlania przycisku "Dalej"
            if(currentStep === 4) {
                // W kroku płatności ukrywamy guzik "Dalej", bo przejście wymusza BLIK
                btnNext.style.display = 'none'; 
            } else if (currentStep === 5) {
                // W podsumowaniu ukrywamy całą nawigację
                navBtns.style.display = 'none'; 
                generateReceipt();
            } else {
                // W pozostałych krokach guzik jest widoczny
                btnNext.style.display = 'inline-block';
            }

            // Aktualizacja paska postępu (kropek)
            updateDots();
            
            // Przewinięcie do góry
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateDots() {
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    dot.classList.add('active');
                } else if (index + 1 < currentStep) {
                    dot.classList.add('completed');
                    dot.innerHTML = '<i class="fas fa-check"></i>';
                } else {
                    dot.innerHTML = index + 1;
                }
            });
        }

        // --- KROK 1: KOLOR ---
        function selectColor(element, name, price, filterVal) {
            document.querySelectorAll('#step-1 .option-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            configState.colorName = name;
            configState.colorPrice = price;
            
            const carImg = document.getElementById('car-preview');
            carImg.style.opacity = 0.7; 
            setTimeout(() => {
                carImg.style.filter = filterVal;
                carImg.style.opacity = 1;
            }, 200);

            updateTotal();
        }

        // --- KROK 2: FELGI ---
        function selectWheels(element, name, price) {
            document.querySelectorAll('.wheel-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            configState.wheelName = name;
            configState.wheelPrice = price;
            updateTotal();
        }

        // --- KROK 3: WERYFIKACJA ---
        function validateStep3(triggerError = false) {
            const c1 = document.getElementById('check-criminal').checked;
            const c2 = document.getElementById('check-license').checked;
            const c3 = document.getElementById('check-bik').checked;
            const msg = document.getElementById('validation-msg');

            // Jeśli wszystkie checkboxy są zaznaczone
            if (c1 && c2 && c3) {
                if(msg) msg.textContent = "";
                return true;
            } else {
                if(triggerError && msg) msg.textContent = "Musisz zaznaczyć wszystkie zgody, aby kontynuować.";
                return false;
            }
        }

        // --- KROK 4: PŁATNOŚĆ ---
        function selectPayment(method) {
            document.querySelectorAll('.pay-btn').forEach(btn => btn.classList.remove('active'));
            
            if (method === 'card') {
                alert('System kartowy w budowie. Proszę wybrać BLIK.');
            } else if (method === 'blik') {
                event.currentTarget.classList.add('active');
                document.getElementById('blik-interface').style.display = 'block';
                
                // Mały timeout żeby input był widoczny przed focusem
                setTimeout(() => {
                    document.getElementById('blik-code').focus();
                }, 100);
            }
        }

        function processBlik() {
            const codeInput = document.getElementById('blik-code');
            const spinner = document.getElementById('blik-spinner');
            
            // Walidacja długości kodu
            if (codeInput.value.length !== 6) {
                alert("Wpisz poprawny, 6-cyfrowy kod BLIK");
                return;
            }

            // UI: Zablokuj input i pokaż spinner
            codeInput.disabled = true;
            spinner.style.display = 'block';

            // Symulacja procesu (3 sekundy)
            setTimeout(() => {
                spinner.style.display = 'none';
                
                // Pobierz wybrany salon przed przejściem dalej
                const salonSelect = document.getElementById('showroom-select');
                if(salonSelect) {
                    configState.salon = salonSelect.value;
                } else {
                    configState.salon = "Warszawa - Centrala"; // Fallback
                }

                // PRZEJŚCIE DO KROKU 5 (Paragon)
                changeStep(1); 
            }, 3000);
        }

        // --- LOGIKA CENOWA ---
        function updateTotal() {
            configState.totalPrice = configState.basePrice + configState.colorPrice + configState.wheelPrice;
            const formatted = configState.totalPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            document.getElementById('header-price').textContent = formatted;
        }

        // --- KROK 5: GENEROWANIE PARAGONU ---
        function generateReceipt() {
            document.getElementById('rec-color').textContent = configState.colorName;
            document.getElementById('rec-wheels').textContent = configState.wheelName;
            
            // Wyciągnięcie samego miasta z nazwy salonu
            const salonFull = configState.salon || "Nie wybrano";
            document.getElementById('rec-salon').textContent = salonFull.split('-')[0];
            
            document.getElementById('rec-total').textContent = configState.totalPrice.toString
